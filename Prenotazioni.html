<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Prenotazione Campi Sportivi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- FIX: Aggiunge la Content Security Policy per permettere la connessione a Supabase -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; connect-src 'self' https://*.supabase.co">
  <!-- Import Supabase Client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{
      --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --text:#e5e7eb; --accent:#22c55e;
      --danger:#ef4444; --warning:#f59e0b; --border:#334155; --card:#0b1220; --blue:#3b82f6;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu; background:linear-gradient(180deg,#030712,#0b1220); color:var(--text)}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid var(--border);position:sticky;top:0;background:rgba(11,18,32,0.85);backdrop-filter:blur(6px);z-index:10}
    h1{font-size:18px;margin:0;display:flex;align-items:center;gap:10px}
    .sub{color:var(--muted);font-weight:400}
    .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{background:#0b1220;border:1px solid var(--border);color:var(--text);padding:8px 12px;border-radius:8px;cursor:pointer;transition:all 0.2s}
    .btn:hover{border-color:#475569}
    .btn:disabled{cursor:not-allowed;opacity:0.5}
    .btn.primary{background:linear-gradient(135deg,#22c55e,#16a34a);border:none;color:#04140a}
    .btn.danger{background:linear-gradient(135deg,#ef4444,#dc2626);border:none;color:#fff}
    .btn.warning{background:linear-gradient(135deg,#f59e0b,#d97706);border:none;color:#1f1302}
    .btn.ghost{background:transparent;border:1px dashed var(--border)}
    input,select,textarea{background:#0b1220;border:1px solid var(--border);color:var(--text);padding:8px 10px;border-radius:8px;width:100%}
    input[type="time"],input[type="date"],select{height:36px}
    main{padding:20px}
    .grid-wrap{overflow:auto;border:1px solid var(--border);border-radius:10px;position:relative}
    table{border-collapse:separate;border-spacing:0;width:100%;min-width:820px}
    thead th{position:sticky;top:0;background:#0b1220;border-bottom:1px solid var(--border);padding:10px;font-weight:600}
    tbody td,tbody th{border-bottom:1px solid #172033}
    tbody th{position:sticky;left:0;background:#0b1220;font-weight:600;color:var(--muted);z-index:1}
    td,th{padding:8px;vertical-align:top}
    .cell{display:flex;flex-direction:column;gap:6px}
    .slot{display:flex;justify-content:space-between;align-items:center;gap:8px;padding:8px;border:1px dashed #23314a;border-radius:8px;background:#0a1326}
    .slot.free{border-style:dashed;color:#9fb2d1}
    .slot.booked{border-color:#2563eb;background:rgba(59,130,246,0.08)}
    .slot.blocked{border-color:#ef4444;background:rgba(239,68,68,0.08);color:#fecaca}
    .slot .meta{display:flex;flex-direction:column;gap:2px}
    .slot .name{font-weight:600}
    .slot .note{font-size:12px;color:#9fb2d1}
    .slot .actions{display:flex;gap:6px;flex-wrap:wrap}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid var(--border);color:#a7b2c7}
    .badge.green{border-color:#065f46;color:#86efac;background:rgba(16,185,129,0.08)}
    .badge.red{border-color:#7f1d1d;color:#fecaca;background:rgba(239,68,68,0.08)}
    .badge.blue{border-color:#1e3a8a;color:#bfdbfe;background:rgba(59,130,246,0.08)}
    .pill{display:inline-block;background:#0b1220;border:1px solid #1e293b;padding:2px 6px;border-radius:6px;font-size:12px;color:#9fb2d1}
    .footer{margin-top:16px;color:#9fb2d1;text-align:center}
    .admin-panel{margin-top:16px;padding:16px;border:1px solid var(--border);border-radius:10px;background:#0b1220;display:none}
    .panel-grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:900px){.panel-grid{grid-template-columns:1fr 1fr}}
    .field-names{display:grid;gap:8px;grid-template-columns:1fr 1fr}
    .muted{color:var(--muted);font-size:12px}
    .sep{height:1px;background:linear-gradient(90deg,transparent,#1f2a44,transparent);margin:8px 0}
    dialog{border:none;border-radius:12px;padding:0;background:#0b1220;color:var(--text);box-shadow:0 15px 45px rgba(0,0,0,0.5)}
    dialog::backdrop{background:rgba(0,0,0,0.5);backdrop-filter:blur(2px)}
    .modal{padding:16px;min-width:320px;max-width:460px}
    .modal h3{margin:0 0 8px 0}
    .modal p{margin:0;color:var(--muted)}
    .row{display:flex;gap:10px;align-items:center}
    .row > *{flex:1}
    .modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
    .hint{font-size:12px;color:#9fb2d1;margin-top:4px}
    .hidden{display:none}
    .loader{position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(11,18,32,0.7);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;z-index:5;color:var(--text);font-size:18px;border-radius:10px}
    .client-mode-banner { padding: 12px; background: var(--blue); color: white; text-align: center; font-weight: 500; }
  </style>
</head>
<body>
  <div id="appLoader" style="display:flex;align-items:center;justify-content:center;height:100vh;font-size:20px;padding:20px;">
    Caricamento applicazione...
  </div>

  <div id="app" class="hidden">
    <header>
      <h1>üéæ Prenotazione Campi <span class="sub">‚Äî vista giornaliera</span></h1>
      <div class="controls">
        <button class="btn" id="prevDay">‚óÄ Ieri</button>
        <input type="date" id="datePicker" />
        <button class="btn" id="nextDay">Domani ‚ñ∂</button>
        <span class="badge blue" id="settingsSummary"></span>
      </div>
      <div class="controls" id="authArea">
        <input type="password" id="adminPinInput" placeholder="PIN admin" />
        <button class="btn" id="adminLoginBtn">Accedi</button>
      </div>
      <div class="controls hidden" id="adminArea">
        <span class="badge green">Admin attivo</span>
        <button class="btn ghost" id="togglePanel">Pannello</button>
        <button class="btn" id="adminLogoutBtn">Esci</button>
      </div>
    </header>

    <main>
      <div class="grid-wrap">
        <div class="loader hidden" id="gridLoader">Caricamento prenotazioni...</div>
        <table>
          <thead>
            <tr id="theadRow"></tr>
          </thead>
          <tbody id="gridBody"></tbody>
        </table>
      </div>
      <div class="footer" id="footerText">
        Suggerimento: clicca su uno slot libero per prenotare.
      </div>

      <div class="admin-panel" id="adminPanel">
        <div class="panel-grid">
          <section>
            <h3>‚öôÔ∏è Impostazioni</h3>
            <div class="sep"></div>
            <div class="row">
              <div><label>Inizio</label><input type="time" id="startTimeInp" /></div>
              <div><label>Fine</label><input type="time" id="endTimeInp" /></div>
            </div>
            <div class="row" style="margin-top:8px">
              <div><label>Durata slot (min)</label><select id="slotMinutesInp"><option>30</option><option>60</option><option>90</option></select></div>
              <div><label>Numero campi</label><select id="numFieldsInp"><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option></select></div>
            </div>
            <div class="field-names" id="fieldNamesWrap" style="margin-top:8px"></div>
            <div class="row" style="margin-top:8px">
              <div>
                <label>PIN admin</label><input type="password" id="pinSettingInp" placeholder="Nuovo PIN" />
                <div class="hint">Lascia vuoto per non cambiare.</div>
              </div>
            </div>
            <div class="actions" style="margin-top:10px">
              <button class="btn primary" id="saveSettingsBtn">Salva impostazioni</button>
            </div>
          </section>
        </div>
      </div>
    </main>

    <!-- Modal prenotazione -->
    <dialog id="bookingModal">
      <div class="modal">
        <h3 id="modalTitle">Nuova prenotazione</h3>
        <div class="muted" id="modalSub"></div>
        <div class="sep"></div>
        <input id="custName" placeholder="Nome e cognome" />
        <input id="custPhone" placeholder="Telefono (opzionale)" style="margin-top:8px" />
        <textarea id="custNote" rows="3" placeholder="Note (opzionale)" style="margin-top:8px"></textarea>
        <div class="actions">
          <button class="btn" id="modalCancel">Annulla</button>
          <button class="btn primary" id="modalConfirm">Conferma</button>
        </div>
      </div>
    </dialog>

    <!-- Modal modifica prenotazione (solo admin) -->
    <dialog id="editModal">
      <div class="modal">
        <h3 id="editTitle">Modifica prenotazione</h3>
        <div class="muted" id="editSub"></div>
        <div class="sep"></div>
        <input id="editName" placeholder="Nome e cognome" />
        <input id="editPhone" placeholder="Telefono (opzionale)" style="margin-top:8px" />
        <textarea id="editNote" rows="3" placeholder="Note (opzionale)" style="margin-top:8px"></textarea>
        <div class="actions">
          <button class="btn danger" id="editDelete">Elimina</button>
          <span style="flex:1"></span>
          <button class="btn" id="editCancel">Chiudi</button>
          <button class="btn primary" id="editSave">Salva</button>
        </div>
      </div>
    </dialog>

    <!-- Modal di notifica (sostituisce alert) -->
    <dialog id="notifyModal">
      <div class="modal">
        <h3 id="notifyTitle"></h3>
        <p id="notifyMessage"></p>
        <div class="actions">
          <button class="btn primary" id="notifyOk">OK</button>
        </div>
      </div>
    </dialog>

    <!-- Modal di conferma (sostituisce confirm) -->
    <dialog id="confirmModal">
        <div class="modal">
            <h3 id="confirmTitle"></h3>
            <p id="confirmMessage"></p>
            <div class="actions">
                <button class="btn" id="confirmCancel">Annulla</button>
                <button class="btn danger" id="confirmConfirm">Conferma</button>
            </div>
        </div>
    </dialog>
  </div>

  <script>
    // ‚ñº‚ñº‚ñº INSERISCI QUI LE TUE CREDENZIALI SUPABASE ‚ñº‚ñº‚ñº
    const SUPABASE_URL = 'https://cqvkgaczgfcdhvmkzjjv.supabase.co'; // Esempio: 'https://xyz.supabase.co'
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNxdmtnYWN6Z2ZjZGh2bWt6amp2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYyNDIwMDAsImV4cCI6MjA3MTgxODAwMH0.x7eF6wyaDX90SfyNrsnqybpr_MYDlU-iy5gXeF1depk'; // Esempio: 'ey...'
    // ‚ñ≤‚ñ≤‚ñ≤ FINE CONFIGURAZIONE SUPABASE ‚ñ≤‚ñ≤‚ñ≤

    // ======== Stato Globale & Riferimenti UI ========
    let settings = {};
    let bookings = [];
    let isAdmin = false;
    let isClientMode = false;
    let configId = null;
    let supabase = null;

    const defaultSettings = {
      start: '09:00', end: '22:00', slotMinutes: 60, numFields: 6,
      fieldNames: ['Campo 1','Campo 2','Campo 3','Campo 4','Campo 5','Campo 6'],
      pin: '1234'
    };

    const el = {
      app: document.getElementById('app'),
      appLoader: document.getElementById('appLoader'),
      datePicker: document.getElementById('datePicker'),
      prevDayBtn: document.getElementById('prevDay'),
      nextDayBtn: document.getElementById('nextDay'),
      theadRow: document.getElementById('theadRow'),
      gridBody: document.getElementById('gridBody'),
      gridLoader: document.getElementById('gridLoader'),
      settingsSummary: document.getElementById('settingsSummary'),
      authArea: document.getElementById('authArea'),
      adminArea: document.getElementById('adminArea'),
      adminLoginBtn: document.getElementById('adminLoginBtn'),
      adminLogoutBtn: document.getElementById('adminLogoutBtn'),
      adminPinInput: document.getElementById('adminPinInput'),
      adminPanel: document.getElementById('adminPanel'),
      togglePanelBtn: document.getElementById('togglePanel'),
      startTimeInp: document.getElementById('startTimeInp'),
      endTimeInp: document.getElementById('endTimeInp'),
      slotMinutesInp: document.getElementById('slotMinutesInp'),
      numFieldsInp: document.getElementById('numFieldsInp'),
      fieldNamesWrap: document.getElementById('fieldNamesWrap'),
      pinSettingInp: document.getElementById('pinSettingInp'),
      saveSettingsBtn: document.getElementById('saveSettingsBtn'),
      bookingModal: document.getElementById('bookingModal'),
      modalTitle: document.getElementById('modalTitle'),
      modalSub: document.getElementById('modalSub'),
      custName: document.getElementById('custName'),
      custPhone: document.getElementById('custPhone'),
      custNote: document.getElementById('custNote'),
      modalCancel: document.getElementById('modalCancel'),
      modalConfirm: document.getElementById('modalConfirm'),
      editModal: document.getElementById('editModal'),
      editTitle: document.getElementById('editTitle'),
      editSub: document.getElementById('editSub'),
      editName: document.getElementById('editName'),
      editPhone: document.getElementById('editPhone'),
      editNote: document.getElementById('editNote'),
      editSave: document.getElementById('editSave'),
      editDelete: document.getElementById('editDelete'),
      editCancel: document.getElementById('editCancel'),
      footerText: document.getElementById('footerText'),
      notifyModal: document.getElementById('notifyModal'),
      notifyTitle: document.getElementById('notifyTitle'),
      notifyMessage: document.getElementById('notifyMessage'),
      notifyOk: document.getElementById('notifyOk'),
      confirmModal: document.getElementById('confirmModal'),
      confirmTitle: document.getElementById('confirmTitle'),
      confirmMessage: document.getElementById('confirmMessage'),
      confirmCancel: document.getElementById('confirmCancel'),
      confirmConfirm: document.getElementById('confirmConfirm'),
    };

    let pendingAction = null;
    let confirmCallback = null;

    // ======== Funzioni Utilit√† ========
    const fmtDateISO = (d) => d.toISOString().slice(0, 10);
    const addDays = (dateStr, delta) => {
      const d = new Date(dateStr + 'T12:00:00');
      d.setDate(d.getDate() + delta);
      return fmtDateISO(d);
    };
    const timeToMin = (t) => { const [h, m] = t.split(':').map(Number); return h * 60 + m; };
    const minToTime = (m) => { const h = Math.floor(m / 60), mm = m % 60; return `${String(h).padStart(2, '0')}:${String(mm).padStart(2, '0')}`; };
    const genSlots = (start, end, step) => {
      const out = [];
      for (let m = timeToMin(start); m < timeToMin(end); m += step) { out.push(minToTime(m)); }
      return out;
    };
    const formatDateHuman = (iso) => new Date(iso + 'T12:00:00').toLocaleDateString('it-IT', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

    // ======== Logica Supabase ========
    async function loadSettings(id) {
      const { data, error } = await supabase.from('configs').select('settings').eq('id', id).single();
      if (error || !data) {
        console.error("Errore caricamento impostazioni:", error);
        return null;
      }
      return { ...defaultSettings, ...data.settings };
    }

    async function saveSettings() {
      el.saveSettingsBtn.disabled = true;
      el.saveSettingsBtn.textContent = 'Salvataggio...';
      const { error } = await supabase.from('configs').update({ settings: settings }).eq('id', configId);
      if (error) {
        console.error("Errore salvataggio impostazioni:", error);
        notify('Errore', 'Errore durante il salvataggio delle impostazioni.');
      } else {
        notify('Successo', 'Impostazioni salvate con successo.');
        await refreshAll();
      }
      el.saveSettingsBtn.disabled = false;
      el.saveSettingsBtn.textContent = 'Salva impostazioni';
    }

    async function loadBookingsForDate(date) {
      el.gridLoader.classList.remove('hidden');
      const { data, error } = await supabase.from('bookings').select('*').eq('config_id', configId).eq('booking_date', date);
      el.gridLoader.classList.add('hidden');
      if (error) {
        console.error("Errore caricamento prenotazioni:", error);
        notify('Errore di Rete', 'Impossibile caricare le prenotazioni.');
        return [];
      }
      return data;
    }

    // ======== Logica di Renderizzazione ========
    function renderHeader() {
      el.theadRow.innerHTML = '<th>Orario</th>';
      for (let i = 0; i < settings.numFields; i++) {
        const th = document.createElement('th');
        th.textContent = settings.fieldNames[i] || `Campo ${i + 1}`;
        el.theadRow.appendChild(th);
      }
      el.settingsSummary.textContent = `${settings.start}‚Äì${settings.end} ‚Ä¢ ${settings.slotMinutes} min ‚Ä¢ ${settings.numFields} campi`;
    }

    function renderGrid() {
      const slots = genSlots(settings.start, settings.end, Number(settings.slotMinutes));
      el.gridBody.innerHTML = '';
      for (const time of slots) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<th>${time}</th>`;
        for (let field = 1; field <= settings.numFields; field++) {
          const td = document.createElement('td');
          const bookingData = bookings.find(b => b.field_id === field && b.start_time.startsWith(time));
          td.innerHTML = renderSlot(time, field, bookingData);
          tr.appendChild(td);
        }
        el.gridBody.appendChild(tr);
      }
      addSlotEventListeners();
    }

    function renderSlot(time, field, data) {
      const fieldName = settings.fieldNames[field - 1] || `Campo ${field}`;
      const date = el.datePicker.value;

      if (!data) {
        return `<div class="slot free"><div class="meta"><div class="name">Libero</div><div class="note">${fieldName}</div></div><div class="actions"><button class="btn" data-action="book" data-date="${date}" data-field="${field}" data-time="${time}">Prenota</button>${isAdmin ? `<button class="btn warning" data-action="block" data-date="${date}" data-field="${field}" data-time="${time}">Blocca</button>` : ''}</div></div>`;
      }
      if (data.type === 'blocked') {
        const reason = (data.details && data.details.reason) || 'Manutenzione';
        return `<div class="slot blocked"><div class="meta"><div class="name">BLOCCATO</div><div class="note">${reason}</div></div>${isAdmin ? `<div class="actions"><button class="btn" data-action="unblock" data-id="${data.id}">Sblocca</button></div>` : ''}</div>`;
      }
      const name = (data.details && data.details.name) || 'Prenotato';
      const phone = (data.details && data.details.phone) || '';
      const note = (data.details && data.details.note) || '';
      const detailsText = [phone, note].filter(Boolean).join(' ‚Ä¢ ');
      return `<div class="slot booked"><div class="meta"><div class="name">${name}</div><div class="note">${detailsText}</div></div>${isAdmin ? `<div class="actions"><button class="btn" data-action="edit" data-id="${data.id}">Modifica</button></div>` : `<span class="pill">${fieldName}</span>`}</div>`;
    }

    // ======== Gestione Eventi ========
    function addSlotEventListeners() {
      el.gridBody.querySelectorAll('button[data-action]').forEach(btn => {
        btn.onclick = (e) => {
          const { action, date, field, time, id } = e.currentTarget.dataset;
          const fieldId = parseInt(field);
          switch (action) {
            case 'book': openBookingModal({ date, field_id: fieldId, time }); break;
            case 'block': blockSlot({ date, field_id: fieldId, time }); break;
            case 'unblock': unblockSlot(parseInt(id)); break;
            case 'edit':
              const booking = bookings.find(b => b.id === parseInt(id));
              if (booking) openEditModal(booking);
              break;
          }
        };
      });
    }

    // ======== Modals ========
    function notify(title, message) {
        el.notifyTitle.textContent = title;
        el.notifyMessage.textContent = message;
        el.notifyModal.showModal();
    }
    function showConfirm(title, message, callback) {
        el.confirmTitle.textContent = title;
        el.confirmMessage.textContent = message;
        confirmCallback = callback;
        el.confirmModal.showModal();
    }
    el.notifyOk.onclick = () => el.notifyModal.close();
    el.confirmCancel.onclick = () => { el.confirmModal.close(); if (confirmCallback) confirmCallback(false); };
    el.confirmConfirm.onclick = () => { el.confirmModal.close(); if (confirmCallback) confirmCallback(true); };

    function openBookingModal({ date, field_id, time }) {
      pendingAction = { date, field_id, time };
      el.modalTitle.textContent = 'Nuova prenotazione';
      el.modalSub.textContent = `${formatDateHuman(date)} ‚Ä¢ ${settings.fieldNames[field_id - 1]} ‚Ä¢ ${time}`;
      el.custName.value = ''; el.custPhone.value = ''; el.custNote.value = '';
      el.bookingModal.showModal();
    }

    function openEditModal(booking) {
      pendingAction = { booking_id: booking.id };
      el.editTitle.textContent = 'Modifica prenotazione';
      el.editSub.textContent = `${formatDateHuman(booking.booking_date)} ‚Ä¢ ${settings.fieldNames[booking.field_id - 1]} ‚Ä¢ ${booking.start_time.slice(0, 5)}`;
      el.editName.value = (booking.details && booking.details.name) || '';
      el.editPhone.value = (booking.details && booking.details.phone) || '';
      el.editNote.value = (booking.details && booking.details.note) || '';
      el.editModal.showModal();
    }

    el.modalCancel.onclick = () => el.bookingModal.close();
    el.editCancel.onclick = () => el.editModal.close();

    el.modalConfirm.onclick = async () => {
      const { date, field_id, time } = pendingAction;
      const name = el.custName.value.trim();
      if (!name) { notify('Campo Obbligatorio', 'Per favore, inserisci un nome.'); return; }
      const newBooking = { config_id: configId, booking_date: date, field_id, start_time: time, type: 'booked', details: { name, phone: el.custPhone.value.trim(), note: el.custNote.value.trim() } };
      el.modalConfirm.disabled = true;
      const { error } = await supabase.from('bookings').insert(newBooking);
      el.modalConfirm.disabled = false;
      if (error) { notify('Errore', 'Errore nella prenotazione. Lo slot potrebbe essere stato occupato.'); console.error(error); } 
      else { el.bookingModal.close(); }
      await refreshBookings();
    };

    el.editSave.onclick = async () => {
      const { booking_id } = pendingAction;
      const updatedDetails = { name: el.editName.value.trim(), phone: el.editPhone.value.trim(), note: el.editNote.value.trim() };
      el.editSave.disabled = true;
      const { error } = await supabase.from('bookings').update({ details: updatedDetails }).eq('id', booking_id);
      el.editSave.disabled = false;
      if (error) { notify('Errore', 'Errore durante la modifica.'); console.error(error); } 
      else { el.editModal.close(); }
      await refreshBookings();
    };

    el.editDelete.onclick = () => {
      showConfirm('Elimina Prenotazione', 'Sei sicuro di voler eliminare questa prenotazione?', async (confirmed) => {
        if (confirmed) {
          const { booking_id } = pendingAction;
          el.editDelete.disabled = true;
          const { error } = await supabase.from('bookings').delete().eq('id', booking_id);
          el.editDelete.disabled = false;
          if (error) { notify('Errore', "Errore durante l'eliminazione."); console.error(error); } 
          else { el.editModal.close(); }
          await refreshBookings();
        }
      });
    };

    // ======== Logica Admin ========
    el.adminLoginBtn.onclick = () => {
      const pin = el.adminPinInput.value.trim();
      if (pin === settings.pin) {
        isAdmin = true;
        el.adminPinInput.value = '';
        el.authArea.classList.add('hidden');
        el.adminArea.classList.remove('hidden');
        el.adminPanel.style.display = 'block';
        el.footerText.textContent = 'Sei in modalit√† admin. Clicca su uno slot per prenotare, bloccare o modificare.';
        renderGrid();
      } else {
        notify('Accesso Fallito', 'Il PIN inserito non √® corretto.');
      }
    };
    el.adminLogoutBtn.onclick = () => {
      isAdmin = false;
      el.authArea.classList.remove('hidden');
      el.adminArea.classList.add('hidden');
      el.adminPanel.style.display = 'none';
      el.footerText.textContent = 'Suggerimento: clicca su uno slot libero per prenotare.';
      renderGrid();
    };
    el.togglePanelBtn.onclick = () => { el.adminPanel.style.display = (el.adminPanel.style.display === 'none' ? 'block' : 'none'); };

    // ======== Impostazioni Admin ========
    function renderSettingsForm() {
      el.startTimeInp.value = settings.start;
      el.endTimeInp.value = settings.end;
      el.slotMinutesInp.value = String(settings.slotMinutes);
      el.numFieldsInp.value = String(settings.numFields);
      renderFieldNamesInputs(settings.numFields);
    }
    function renderFieldNamesInputs(num) {
      el.fieldNamesWrap.innerHTML = '';
      for (let i = 0; i < num; i++) {
        const input = document.createElement('input');
        input.type = 'text';
        input.id = `fieldName_${i}`;
        input.value = settings.fieldNames[i] || `Campo ${i + 1}`;
        input.placeholder = `Nome Campo ${i + 1}`;
        el.fieldNamesWrap.appendChild(input);
      }
    }
    el.numFieldsInp.onchange = () => {
      const newNum = parseInt(el.numFieldsInp.value);
      const currentNames = [];
      for (let i = 0; i < settings.numFields; i++) {
        const input = document.getElementById(`fieldName_${i}`);
        if (input) currentNames.push(input.value);
      }
      settings.fieldNames = currentNames;
      renderFieldNamesInputs(newNum);
    };
    el.saveSettingsBtn.onclick = () => {
      const start = el.startTimeInp.value;
      const end = el.endTimeInp.value;
      if (timeToMin(end) <= timeToMin(start)) {
        notify('Errore Impostazioni', "L'orario di fine deve essere successivo a quello di inizio.");
        return;
      }
      const numFields = parseInt(el.numFieldsInp.value);
      const newNames = [];
      for (let i = 0; i < numFields; i++) {
        const val = (document.getElementById(`fieldName_${i}`)?.value || '').trim();
        newNames.push(val || `Campo ${i + 1}`);
      }
      settings.start = start;
      settings.end = end;
      settings.slotMinutes = parseInt(el.slotMinutesInp.value);
      settings.numFields = numFields;
      settings.fieldNames = newNames;
      const newPin = el.pinSettingInp.value.trim();
      if (newPin) settings.pin = newPin;
      saveSettings();
    };

    // ======== Azioni di Dominio ========
    async function blockSlot({ date, field_id, time }) {
      const newBlock = { config_id: configId, booking_date: date, field_id, start_time: time, type: 'blocked', details: { reason: 'Blocco manuale' } };
      const { error } = await supabase.from('bookings').insert(newBlock);
      if (error) notify('Errore', 'Impossibile bloccare lo slot.');
      await refreshBookings();
    }
    async function unblockSlot(bookingId) {
      const { error } = await supabase.from('bookings').delete().eq('id', bookingId);
      if (error) notify('Errore', 'Impossibile sbloccare lo slot.');
      await refreshBookings();
    }

    // ======== Navigazione e Aggiornamento ========
    async function refreshBookings() {
      bookings = await loadBookingsForDate(el.datePicker.value);
      renderGrid();
    }
    async function refreshAll() {
      settings = await loadSettings(configId);
      if (settings) {
        renderHeader();
        renderSettingsForm();
        await refreshBookings();
      }
    }
    el.datePicker.onchange = refreshBookings;
    el.prevDayBtn.onclick = () => { el.datePicker.value = addDays(el.datePicker.value, -1); refreshBookings(); };
    el.nextDayBtn.onclick = () => { el.datePicker.value = addDays(el.datePicker.value, 1); refreshBookings(); };

    // ======== Inizializzazione App ========
    async function init() {
      try {
        const params = new URLSearchParams(window.location.search);
        configId = params.get('id');
        isClientMode = !!configId;
        if (!isClientMode) { configId = prompt("Inserisci l'ID della configurazione da gestire:", "1"); }
        if (!configId) { throw new Error("ID configurazione non specificato. Aggiungi ?id=1 (o un altro ID) all'URL per iniziare."); }
        if (!SUPABASE_URL || !SUPABASE_ANON_KEY) { throw new Error("Credenziali Supabase non configurate. Inserisci URL e Chiave API nello script per collegare il database."); }
        if (!window.supabase) { throw new Error("Libreria Supabase non caricata. Controlla la connessione a internet o il link allo script nel tag <head>."); }
        
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        settings = await loadSettings(configId);
        
        if (!settings) { throw new Error(`Impossibile caricare la configurazione con ID=${configId}.<br><br><b>Possibili cause:</b><br>1. L'ID nell'URL non esiste nel database.<br>2. Le credenziali Supabase (URL/Chiave) sono errate.<br>3. Le policy di sicurezza (RLS) sulla tabella 'configs' non permettono la lettura pubblica.`); }

        if (isClientMode) {
          document.querySelector('header').style.display = 'none';
          el.adminPanel.style.display = 'none';
          const clientBanner = document.createElement('div');
          clientBanner.className = 'client-mode-banner';
          clientBanner.innerHTML = `<h1>${settings.fieldNames.join(' / ')}</h1><p>Seleziona un orario libero per la tua prenotazione del ${formatDateHuman(fmtDateISO(new Date()))}</p>`;
          el.app.prepend(clientBanner);
        }

        el.datePicker.value = fmtDateISO(new Date());
        renderHeader();
        renderSettingsForm();
        await refreshBookings();
        el.appLoader.classList.add('hidden');
        el.app.classList.remove('hidden');
      } catch (error) {
        console.error("Errore fatale durante l'inizializzazione:", error);
        el.appLoader.innerHTML = `<div style="text-align: left; background: #2d1a1a; border: 1px solid var(--danger); padding: 20px; border-radius: 8px; max-width: 600px;"><h3 style="color: var(--danger); margin-top: 0;">Oops! Qualcosa √® andato storto.</h3><p style="color: var(--text);">${error.message}</p><p style="font-size: 12px; color: var(--muted); margin-top: 16px;">Controlla la console del browser (tasto F12) per maggiori dettagli tecnici.</p></div>`;
      }
    }

    init();
  </script>
</body>
</html>
